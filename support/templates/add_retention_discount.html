{% extends "adminlte/base.html" %}
{% load static i18n widget_tweaks %}
{% block title %}
  {% trans "Add retention discount" %}
{% endblock title %}

{% block extra_js %}
  <script type="text/javascript">
$( function() {
  // Set minimum date to tomorrow
  var tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  var tomorrowStr = tomorrow.toISOString().split('T')[0];
  $("#id_start_date").attr("min", tomorrowStr);

  function activateSend() {
      var disable = false;
      var hasRetentionDiscount = $(".enable-product:checked").length > 0;
      var hasProductRemoval = $(".remove-product:checked").length > 0;

      // Count subscription products (type "S") only, not discounts
      var totalSubscriptionProducts = $(".remove-product[data-product-type='S']").length;
      var removedSubscriptionProducts = $(".remove-product[data-product-type='S']:checked").length;

      // Check if all subscription products are being removed
      if (removedSubscriptionProducts >= totalSubscriptionProducts && totalSubscriptionProducts > 0) {
        disable = true;
        $("#custom_error_message").text("{% trans 'Cannot remove all subscription products - at least one must remain' %}");
      }
      // Allow submission if either retention discount is selected OR products are being removed
      else if (!hasRetentionDiscount && !hasProductRemoval) {
        disable = true;
        $("#custom_error_message").text("{% trans 'Select at least one retention discount or mark products to remove' %}");
      } else {
        disable = false;
      }

      if (disable == false) {
        $("#send_form").removeAttr("disabled");  // Enable the send button
        $("#custom_error_message").text("");
      } else {
        $("#send_form").attr("disabled", "disabled");  // Disable the send button
      }

    };

  $("input:checkbox").change(function(){
      activateSend();
    });

});


  </script>
{% endblock %}

{% block no_heading %}
  <h1>
    {% trans "Add retention discount" %}
  </h1>
  <p>{% trans "Select retention discount products to add to the subscription" %}</p>
{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-12">
      <div class="card card-info collapsed-card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-info-circle"></i> {% trans "Instructions" %}
          </h3>
          <div class="card-tools">
            <button type="button" class="btn btn-tool" data-card-widget="collapse">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
        <div class="card-body">
          <h5>{% trans "How to use this form:" %}</h5>
          <ol>
            <li><strong>{% trans "Select retention discounts" %}:</strong> {% trans "Choose one or more retention discount products to offer to the customer" %}</li>
            <li><strong>{% trans "Remove products (optional)" %}:</strong> {% trans "If the customer wants to remove any products, check the boxes in the 'Remove these products' section" %}</li>
            <li><strong>{% trans "Set start date" %}:</strong> {% trans "Choose when the new subscription should start (must be at least tomorrow)" %}</li>
            <li><strong>{% trans "Add petition channel and notes" %}:</strong> {% trans "Select how the customer contacted you and add any relevant notes" %}</li>
          </ol>
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>{% trans "Important:" %}</strong>
            <ul class="mb-0">
              <li>{% trans "You must select at least one retention discount OR mark products to remove" %}</li>
              <li>{% trans "You cannot remove all products - at least one subscription product must remain" %}</li>
              <li>{% trans "The start date must be at least tomorrow" %}</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-9">
      <div class="card">
        <div class="card-header p-2">
          <h3>{% trans "Retention discounts" %}</h3>
        </div>
        <div class="card-body">
          <form method="post" id="form">
            {% csrf_token %}
            {% if form.errors %}
              {% for field in form %}
                {% for error in field.errors %}
                  <div class="alert alert-danger">
                    <strong>{{ error|escape }}</strong>
                  </div>
                {% endfor %}
              {% endfor %}
              {% for error in form.non_field_errors %}
                <div class="alert alert-danger">
                  <strong>{{ error|escape }}</strong>
                </div>
              {% endfor %}
            {% endif %}
            <div class="row">
              <div class="col-6">
                <div class="form-group">
                  <label>{% trans "Current products" %}</label>
                  <ul>
                    {% for subscriptionproduct in subscription.get_subscriptionproducts %}
                      <li>{{ subscriptionproduct.product.name }}</li>
                    {% endfor %}
                  </ul>
                </div>
                <div class="form-group">
                  <label>{% trans "Add these retention discounts" %}</label>
                  {% if retention_products %}
                    {% for product in retention_products %}
                      <div class="form-check">
                        <input id="retentionproduct-{{ product.id }}"
                               class="enable-product form-check-input"
                               type="checkbox"
                               name="retentionproduct-{{ product.id }}">
                        <label class="form-check-label" for="retentionproduct-{{ product.id }}">
                          {{ product.name }}
                          {% if product.price %}
                            ({{ product.price }})
                          {% endif %}
                        </label>
                      </div>
                    {% endfor %}
                  {% else %}
                    <div class="alert alert-warning">
                      {% trans "No retention discount products available. Please create retention discount products first." %}
                    </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-6">
                <div class="form-group">
                  <label for="id_start_date">{{ form.start_date.label }}</label>
                  {% render_field form.start_date class="form-control" type="date" id="id_start_date" %}
                  <span class="error invalid-feedback">{{ form.start_date.errors }}</span>
                  <small class="form-text text-muted">{% trans "Must be at least tomorrow" %}</small>
                </div>
                <div class="form-group">
                  <label for="id_unsubscription_channel">{{ form.unsubscription_channel.label }}</label>
                  {{ form.unsubscription_channel }}
                  <span class="error invalid-feedback">{{ form.unsubscription_channel.errors }}</span>
                </div>
                <div class="form-group">
                  <label for="id_unsubscription_addendum">
                    {{ form.unsubscription_addendum.label }} ({% trans "For old subscription" %})
                  </label>
                  {{ form.unsubscription_addendum }}
                  <span class="error invalid-feedback">{{ form.unsubscription_addendum.errors }}</span>
                </div>
                <div class="form-group">
                  <label>{% trans "Remove these products" %} ({% trans "optional" %})</label>
                  {% for subscriptionproduct in subscription.get_subscriptionproducts %}
                    <div class="form-check">
                      <input id="id-sp-{{ subscriptionproduct.id }}"
                             class="form-check-input remove-product"
                             type="checkbox"
                             name="sp-{{ subscriptionproduct.id }}"
                             data-product-type="{{ subscriptionproduct.product.type }}">
                      <label class="form-check-label" for="id-sp-{{ subscriptionproduct.id }}">
                        {{ subscriptionproduct.product.name }}
                      </label>
                    </div>
                  {% endfor %}
                </div>
              </div>
              <div class="form-group text-right">
                <span id="custom_error_message" class="text-danger"><small>{% trans "Select a retention discount to continue" %}</small></span>
                <input disabled="disabled"
                       type="submit"
                       id="send_form"
                       name="submit"
                       value='{% trans "Send" %}'
                       class="btn bg-gradient-primary">
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
