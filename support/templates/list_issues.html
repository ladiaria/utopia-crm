{% extends "adminlte/base.html" %}
{% load static i18n widget_tweaks %}
{% block title %}
  {% trans "List issues" %}
{% endblock title %}

{% block stylesheets %}
  {{ block.super }}
  <link rel="stylesheet"
        href="{% static '/admin-lte/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}" />
  <link rel="stylesheet" href="{% static 'css/chosen/chosen.min.css' %}" />
{% endblock %}

{% block no_heading %}
<h1>{% trans "List issues" %}</h1>
<p>{% trans "List of issues" %}</p>
{% endblock no_heading %}

{% block extra_js %}
  <script type="text/javascript"
          src="{% static '/admin-lte/plugins/datatables/jquery.dataTables.min.js' %}"></script>
  <script src="{% static '/admin-lte/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
  <script src="{% static 'js/chosen.jquery.min.js' %}"></script>
  <script>
  $(function() {
    // Initialize Chosen for select elements
    $('select.form-control').chosen({
      allow_single_deselect: true,
      no_results_text: "{% trans 'No results match' %}",
      placeholder_text_single: "{% trans 'Select an option' %}",
      width: "100%"
    });

    // Date range functionality for Issue Date
    $('#id_date').change(function(){
      var option = $(this).val();
      if(option == "custom") {
        $('.creation-range').removeClass('d-none');
      }else {
        $('.creation-range').addClass('d-none');
        $('#id_date_gte').attr('value', '');
        $('#id_date_lte').attr('value', '');
      }
    });
    $('#id_date').change();
    $('#id_date_gte').datepicker({ dateFormat: 'yy-mm-dd' });
    $('#id_date_lte').datepicker({ dateFormat: 'yy-mm-dd' });

    // Date range functionality for Next Action Date
    $('#id_next_action_date').change(function(){
      var option = $(this).val();
      if(option == "custom") {
        $('.next-action-range').removeClass('d-none');
      }else {
        $('.next-action-range').addClass('d-none');
        $('#id_next_action_date_gte').attr('value', '');
        $('#id_next_action_date_lte').attr('value', '');
      }
    });
    $('#id_next_action_date').change();
    $('#id_next_action_date_gte').datepicker({ dateFormat: 'yy-mm-dd' });
    $('#id_next_action_date_lte').datepicker({ dateFormat: 'yy-mm-dd' });

    // Dynamic subcategory filtering
    var categorySubcategories = {{ category_subcategories_json|safe }};
    var $categorySelect = $('#id_category');
    var $subcategorySelect = $('#id_sub_category');

    function updateSubcategories() {
      var selectedCategory = $categorySelect.val();
      var $currentValue = $subcategorySelect.val();

      // Clear current options except the empty option
      $subcategorySelect.find('option:not([value=""])').remove();

      if (selectedCategory && categorySubcategories[selectedCategory]) {
        // Add category-specific subcategories
        categorySubcategories[selectedCategory].forEach(function(subcategory) {
          var $option = $('<option></option>')
            .attr('value', subcategory.id)
            .text(subcategory.name);
          $subcategorySelect.append($option);
        });
      }

      // Add general subcategories (without category) if they exist
      if (categorySubcategories['null']) {
        categorySubcategories['null'].forEach(function(subcategory) {
          var $option = $('<option></option>')
            .attr('value', subcategory.id)
            .text(subcategory.name + ' (General)')
            .css('font-style', 'italic');
          $subcategorySelect.append($option);
        });
      }

      // If no category is selected, show all subcategories
      if (!selectedCategory) {
        Object.keys(categorySubcategories).forEach(function(category) {
          if (category !== 'null') {
            categorySubcategories[category].forEach(function(subcategory) {
              var $option = $('<option></option>')
                .attr('value', subcategory.id)
                .text(subcategory.name);
              $subcategorySelect.append($option);
            });
          }
        });

        // Add general subcategories
        if (categorySubcategories['null']) {
          categorySubcategories['null'].forEach(function(subcategory) {
            var $option = $('<option></option>')
              .attr('value', subcategory.id)
              .text(subcategory.name + ' (General)')
              .css('font-style', 'italic');
            $subcategorySelect.append($option);
          });
        }
      }

      // Restore the previously selected value if it still exists
      if ($currentValue) {
        $subcategorySelect.val($currentValue);
      }

      // Update Chosen after modifying options
      $subcategorySelect.trigger('chosen:updated');
    }

    // Initialize subcategories on page load
    updateSubcategories();

    // Update subcategories when category changes (using Chosen event)
    $categorySelect.on('change', updateSubcategories);
  });
  </script>
{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-body">
          <form method="get" id="form">
            <div class="row">
              <div class="form-group col">
                <label for="status">{% trans "Status" %}</label>
                {% render_field filter.form.status class="form-control" %}
              </div>
              <div class="form-group col">
                <label for="category">{% trans "Category" %}</label>
                {% render_field filter.form.category class="form-control" %}
              </div>
              <div class="form-group col">
                <label for="sub_category">{% trans "Subcategory" %}</label>
                {% render_field filter.form.sub_category class="form-control" %}
              </div>
              <div class="form-group col">
                <label for="assigned_to">{% trans "Assigned to" %}</label>
                {% render_field filter.form.assigned_to class="form-control" %}
              </div>
            </div>
            <div class="row">
              <div class="form-group col-md-6">
                <label for="date">
                  {{ filter.form.date.label }}
                  <small class="text-muted">{{ filter.form.date.help_text }}</small>
                </label>
                {% render_field filter.form.date class="form-control" %}
              </div>
              <div class="form-group col-md-6">
                <label for="next_action_date">
                  {{ filter.form.next_action_date.label }}
                  <small class="text-muted">{{ filter.form.next_action_date.help_text }}</small>
                </label>
                {% render_field filter.form.next_action_date class="form-control" %}
              </div>
            </div>
            <div class="row">
              <div class="creation-range hidden d-none col-md-6">
                <div class="row">
                  <div class="form-group col">
                    <label for="date_gte">{{ filter.form.date_gte.label }}</label>
                    {% render_field filter.form.date_gte class="form-control" %}
                  </div>
                  <div class="form-group col">
                    <label for="date_lte">{{ filter.form.date_lte.label }}</label>
                    {% render_field filter.form.date_lte class="form-control" %}
                  </div>
                </div>
              </div>
              <div class="next-action-range hidden d-none col-md-6">
                <div class="row">
                  <div class="form-group col">
                    <label for="next_action_date_gte">{{ filter.form.next_action_date_gte.label }}</label>
                    {% render_field filter.form.next_action_date_gte class="form-control" %}
                  </div>
                  <div class="form-group col">
                    <label for="next_action_date_lte">{{ filter.form.next_action_date_lte.label }}</label>
                    {% render_field filter.form.next_action_date_lte class="form-control" %}
                  </div>
                </div>
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                {% if count %}
                  <div class="callout callout-info py-2 px-3 mb-0">
                    <strong>{{ count }}</strong> {% trans "issues found" %}
                  </div>
                {% endif %}
              </div>
              <div class="btn-group">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-search"></i> {% trans "Search" %}
                </button>
                <button type="submit" name="export" class="btn btn-success" value="1">
                  <i class="fas fa-file-csv"></i> {% trans "Export to CSV" %}
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <table id="table1" class="table table-bordered table-striped">
            <thead>
              <tr role="row">
                <th>{% trans "Id" %}</th>
                <th>
                  <a href="?{% for key, value in request.GET.items %}{% if key != 'order_by' and key != 'p' %}{{ key }}={{ value }}&{% endif %}{% endfor %}order_by={% if request.GET.order_by == 'date' %}-date{% else %}date{% endif %}" class="text-dark">
                    {% trans "Start date" %}
                    {% if request.GET.order_by == 'date' %}<i class="fas fa-sort-up"></i>{% elif request.GET.order_by == '-date' %}<i class="fas fa-sort-down"></i>{% else %}<i class="fas fa-sort"></i>{% endif %}
                  </a>
                </th>
                <th>{% trans "Contact" %}</th>
                <th>{% trans "Category" %}</th>
                <th>{% trans "Subcategory" %}</th>
                <th>{% trans "Status" %}</th>
                <th>{% trans "Activities" %}</th>
                <th>
                  <a href="?{% for key, value in request.GET.items %}{% if key != 'order_by' and key != 'p' %}{{ key }}={{ value }}&{% endif %}{% endfor %}order_by={% if request.GET.order_by == 'next_action_date' %}-next_action_date{% else %}next_action_date{% endif %}" class="text-dark">
                    {% trans "Next action date" %}
                    {% if request.GET.order_by == 'next_action_date' %}<i class="fas fa-sort-up"></i>{% elif request.GET.order_by == '-next_action_date' %}<i class="fas fa-sort-down"></i>{% else %}<i class="fas fa-sort"></i>{% endif %}
                  </a>
                </th>
                <th>{% trans "Assigned to" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for issue in page_obj %}
                <tr role="row">
                  <td>
                    <a href='{% url "view_issue" issue.id %}'>{{ issue.id }}</a>
                  </td>
                  <td>{{ issue.date }}</td>
                  <td>{{ issue.contact }}</td>
                  <td>{{ issue.get_category }}</td>
                  <td>{{ issue.get_subcategory }}</td>
                  <td>{{ issue.status }}</td>
                  <td>{{ issue.activity_count }}</td>
                  <td>{{ issue.next_action_date|default_if_none:"-" }}</td>
                  <td>{{ issue.assigned_to|default_if_none:"-" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  {% if page_obj.has_other_pages %}
    {% include "components/_pagination.html" %}
  {% endif %}
{% endblock %}
