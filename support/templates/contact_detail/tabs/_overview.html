{% load i18n core_tags %}
<div class="row">
  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-user"></i> {% trans "Contact information" %}</h3>
      </div>
      <div class="card-body">
        <div class="mb-2">
          <i class="fas fa-user text-primary"></i> <strong>{% trans "Name" %}:</strong> {{ contact.get_full_name }}
        </div>
        {% if contact.id_document %}
          <div class="mb-2">
            <i class="fas fa-id-card text-secondary"></i> <strong>{% trans "ID" %}:</strong>
            {{ contact.id_document_type|default_if_none:"-" }} {{ contact.id_document }}
          </div>
        {% endif %}
        <div class="mb-2">
          <i class="fas fa-envelope text-info"></i> <strong>{% trans "Email" %}:</strong>
          {% if contact.email %}
            <a href="mailto:{{ contact.email }}">{{ contact.email }}</a>
          {% else %}
            -
          {% endif %}
        </div>
        <div class="mb-2">
          <i class="fas fa-phone text-success"></i> <strong>{% trans "Phone" %}:</strong>
          {% if contact.phone %}
            <a href="tel:{{ contact.phone }}">{{ contact.phone.as_national }}</a>
          {% else %}
            -
          {% endif %}
        </div>
        {% if contact.mobile %}
          <div class="mb-2">
            <i class="fas fa-mobile-alt text-success"></i> <strong>{% trans "Mobile" %}:</strong>
            <a href="tel:{{ contact.mobile }}">{{ contact.mobile.as_national }}</a>
          </div>
        {% endif %}
        {% if contact.work_phone %}
          <div class="mb-2">
            <i class="fas fa-building text-secondary"></i> <strong>{% trans "Work" %}:</strong> {{ contact.work_phone }}
          </div>
        {% endif %}
        {% if addresses %}
          <div class="mt-3">
            <h6 class="text-muted mb-2"><i class="fas fa-map-marker-alt"></i> {% trans "Addresses" %}</h6>
            {% for address in addresses %}
              {% if address.address_1 %}
                <div class="mb-2 pl-3">
                  {{ address.address_1|default:"-" }}
                  {% if georef_activated %}
                    {% if address.needs_georef %}
                      <i class="fas fa-times-circle text-danger ml-1" title="{% trans "Needs georeferencing" %}"></i>
                    {% elif not address.verified %}
                      <a href="{% url "normalizar_direccion" contact.id address.id %}" class="btn btn-xs btn-info ml-1">
                        <i class="fas fa-map-marked-alt"></i> {% trans "Normalize" %}
                      </a>
                    {% else %}
                      <i class="fas fa-check-circle text-success ml-1" title="{% trans "Verified" %}"></i>
                    {% endif %}
                  {% endif %}
                </div>
              {% else %}
                <div class="mb-2 pl-3">
                  {% trans "No address specified" %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
        {% if contact.tags.all %}
          <div class="mt-3">
            <h6 class="text-muted mb-2"><i class="fas fa-tags"></i> {% trans "Tags" %}</h6>
            <div class="d-flex flex-wrap">
              {% for tag in contact.tags.all %}
                <a href="{% url "contact_list" %}?tags={{ tag.name }}" class="badge badge-secondary mr-1 mb-1">{{ tag }}</a>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
      <div class="card-footer bg-light">
        <div class="d-flex flex-wrap justify-content-end">
          <a href="{% url "agregar_direccion" contact.id %}" class="btn btn-sm btn-success mr-1 mb-1">
            <i class="fas fa-plus"></i> {% trans "Add address" %}
          </a>
          <a href="{% url "edit_contact" contact.id %}" class="btn btn-sm btn-primary mb-1">
            <i class="fas fa-edit"></i> {% trans "Edit info" %}
          </a>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-dollar-sign"></i> {% trans "Payments" %}</h3>
      </div>
      <div class="card-body">
        {% block payment_requests %}
        {% endblock payment_requests %}

        {% if last_paid_invoice or debt %}
          {% if debt %}
            <div class="alert alert-danger py-2 px-3 mb-3">
              <i class="fas fa-exclamation-triangle"></i> <strong>{% trans "Debt" %}:</strong> ${{ debt }}
              <small class="d-block mt-1">{{ expired_invoices_count }} {% trans "overdue invoices" %}</small>
            </div>
          {% endif %}

          {% if last_paid_invoice %}
            <div class="mb-2">
              <i class="fas fa-calendar-check text-success"></i> <strong>{% trans "Latest payment" %}:</strong>
              {{ last_paid_invoice.payment_date|date:"d/m/Y" }} <span class="text-success">${{ last_paid_invoice.amount }}</span>
            </div>
            <div class="mb-2">
              <i class="fas fa-file-invoice-dollar text-info"></i> <strong>{% trans "Total paid" %}:</strong> {{ contact.get_paid_invoices_count }} {% trans "invoices" %}
            </div>
          {% endif %}

          {% if latest_invoice %}
            <div class="mb-2">
              <i class="fas fa-credit-card text-secondary"></i> <strong>{% trans "Payment method" %}:</strong> {{ latest_invoice.get_payment_type_display|default:"-" }}
            </div>
          {% endif %}
        {% else %}
          <p class="text-muted mb-0">
            <i class="fas fa-info-circle"></i> {% trans "This contact has no payment data" %}
          </p>
        {% endif %}
      </div>
    </div>
    {% if contact.notes %}
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">{% trans "Notes" %}</h3>
        </div>
        <div class="card-body">{{ contact.notes|linebreaks }}</div>
      </div>
    {% endif %}
  </div>
  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">{% trans "Subscriptions" %} ({{ overview_subscriptions_count }})</h3>
        <div class="card-tools">
          {% block products_amount %}
          {% endblock products_amount %}

          {% if contact.invoice_set.exists %}
            <h3 class="bg-success font-weight-bold rounded d-inline-block p-1"
                title="AÃ±o de primera factura"
                data-toggle="tooltip">{{ contact.date_of_first_invoice.year }}</h3>
          {% endif %}
        </div>
      </div>
      <div class="card-body p-0">
        {% if active_subscriptions or future_subscriptions or awaiting_payment_subscriptions %}
          <div class="list-group list-group-flush">
            {% for subscription in active_subscriptions %}
              {% include "contact_detail/tabs/includes/_overview_subscription_list_item.html" %}
            {% endfor %}
            {% for subscription in future_subscriptions %}
              {% include "contact_detail/tabs/includes/_overview_subscription_list_item.html" with future=True %}
            {% endfor %}
            {% for subscription in awaiting_payment_subscriptions %}
              {% include "contact_detail/tabs/includes/_overview_subscription_list_item.html" with awaiting_payment=True %}
            {% endfor %}
          </div>
        {% else %}
          <div class="p-3">{% trans "This contact has no subscriptions to show" %}</div>
        {% endif %}
      </div>
      {% if request.user|in_group:"Support" or request.user|in_group:"Managers" %}
        <div class="card-footer d-flex justify-content-end">
          {% if perms.core.can_add_corporate_subscription %}
            <a href="{% url "create_corporate_subscription" contact.id %}"
               class="btn btn-primary"><i class="fas fa-plus-circle"></i> {% trans "Create corporate subscription" %}</a>
          {% endif %}
          <a href="{% url "new_subscription" contact.id %}"
             class="btn btn-primary"><i class="fas fa-plus-circle"></i> {% trans "Add subscription" %}</a>
        </div>
      {% endif %}
    </div>
  </div>
  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">{% trans "Latest issues" %}</h3>
      </div>
      <div class="card-body">
        {% if last_issues %}
          <div class="list-group-flush">
            {% for issue in last_issues %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between">
                  <p class="mb-1 font-weight-bold">{{ issue.get_category }} - {{ issue.get_subcategory }}</p>
                  <p class="mb-1">
                    <a href="{% url "view_issue" issue.id %}" class="btn btn-primary btn-sm"><i class="fas fa-eye"></i></a>
                  </p>
                </div>
                <p class="mb-1">
                  <span class="font-weight-bold">{% trans "Status" %}:</span> {{ issue.get_status|default_if_none:"" }}
                </p>
                <p class="mb-1">
                  <span class="font-weight-bold">{% trans "Created" %}:</span> {{ issue.date_created }}
                </p>
                <p class="mb-1">
                  <span class="font-weight-bold">{% trans "Notes" %}:</span> {{ issue.notes|default_if_none:""|linebreaks }}
                </p>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <dl>
            <dd>
              {% trans "This contact has no issues" %}
            </dd>
          </dl>
        {% endif %}
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">{% trans "Latest activities" %}</h3>
      </div>
      <div class="card-body">
        {% if activities %}
          <div class="list-group-flush">
            {% for a in activities %}
              <div class="list-group-item">
                <p class="mb-1 font-weight-bold">
                  {{ a.get_type_display }}
                  {% if a.campaign %}<span class="font-italic">{{ a.campaign.name }}</span>{% endif %}
                </p>
                {% if a.created_by %}
                  <p class="mb-1">
                    <span class="font-weight-bold">{% trans "Created by" %}:</span>
                    {{ a.created_by_name|default_if_none:"-" }}
                  </p>
                {% endif %}
                {% if a.seller_console_action %}
                  <p class="mb-1">
                    <span class="font-weight-bold">{% trans "Seller console action" %}:</span>
                    {{ a.seller_console_action.name }}
                  </p>
                {% endif %}
                {% if a.seller %}
                  <p class="mb-1">
                    <span class="font-weight-bold">{% trans "Seller" %}:</span>
                    {{ a.seller.name }}
                  </p>
                {% endif %}
                <p class="mb-1">
                  <span class="font-weight-bold">{% trans "Status" %}:</span> {{ a.get_status }}
                </p>
                {% if a.datetime %}
                  <p class="mb-1">
                    <span class="font-weight-bold">{% trans "Date" %}:</span> {{ a.datetime|date:"SHORT_DATETIME_FORMAT" }}
                  </p>
                {% endif %}
                {% if a.notes %}
                  <p class="mb-1">
                    <span class="font-weight-bold">{% trans "Notes" %}:</span> {{ a.notes|linebreaks|default_if_none:"" }}
                  </p>
                {% endif %}
                {% if a.topic %}
                  <p class="mb-1">
                    <span class="font-weight-bold">{% trans "Topic" %}:</span> {{ a.topic }}
                  </p>
                {% endif %}
                {% if a.response %}
                  <p class="mb-1">
                    <span class="font-weight-bold">{% trans "Response" %}:</span> {{ a.response|linebreaks|default_if_none:"" }}
                  </p>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <dl>
            <dd>
              {% trans "This contact has no activities" %}
            </dd>
          </dl>
        {% endif %}
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          {% trans "Newsletters" %}
          {% if newsletters %}
            {# show icon references #}
            <span>
              ( <i class="fas fa-check-circle"></i> = {% trans "active" %},
              <i class="fas fa-times-circle"></i> = {% trans "inactive" %} )
            </span>
          {% endif %}
        </h3>
      </div>
      <div class="card-body">
        {% if newsletters %}
          <ul class="pl-3">
            {% for newsletter in newsletters %}
              <li>
                <i class="fas fa-{% if newsletter.active %}check{% else %}times{% endif %}-circle">
                </i>
                {{ newsletter.product.name }}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          {% trans "This contact has no newsletter subscriptions" %}
        {% endif %}
      </div>
    </div>
  </div>
</div>
