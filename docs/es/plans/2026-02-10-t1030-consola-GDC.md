# Plan la consola de Gestión de Comunidad (GDC)

## Parte 1: Componente de incidencias asignadas a los agentes

### Contexto

Para los usuarios del subgrupo de Support, generar un menú Consola de GDC, en la que vean las incidencias (modelo `Issue` de la app `support`), agrupadas por Categoría-Subcategoría. Al ingresar a cada agrupamiento, se debe reagrupar por Vencidas, Hoy y Futuras.

### Desarrollo del contexto e implementación

En vez de utilizar un subgrupo de "Support", usaremos un permiso específico para poder acceder a la consola de GDC. Luego se creará un nuevo subgrupo de "GDC" que tendrá este permiso. Tendremos que darle un nombre en inglés para continuar con la integridad del proyecto principal utopia-crm al estar escrito en inglés.

Las incidencias se asignan a los agentes de GDC a través del campo `assigned_to` del modelo `Issue`.

La parte frontal de esta consola tendrá un componente que muestre las incidencias que están asignadas a los agentes de GDC junto a tres columnas: Vencidas, Hoy y Futuras. Para determinar si una incidencia está vencida, hoy o futura, se debe usar el atributo `date` del modelo `Issue`.

Cada una de estas columnas será un componente interactivo que permitirá al usuario filtrar las incidencias por el criterio correspondiente utilizando la vista que ya existe para las incidencias (support/views/all_views.py -> `IssueListView`). Los criterios correspondientes son las subcategorías de las incidencias y la fecha que la columna representa (vencidas, hoy o futuras).

Si no existe forma de poder filtrar por fecha en la vista existente, explorar si es necesario crear una nueva vista o adaptarlas para poder filtrar por fecha. La vista debe ser capaz de filtrar por fecha y por subcategoría y por lo que sabemos ya puede filtrar por subcategorías.

En principio la vista debe mostrar solo este componente en una tarjeta y se valora que la vista tenga un diseño responsive y la tabla donde se encuentren las incidencias sea interactiva.

Debemos decidir cuál es la forma más elegante de mostrar las agrupaciones de incidencias por categoría y subcategoría, si usar tablas que permitan expandir las subcategorías o si usar un diseño diferente, pero la idea es que se pueda ver a golpe de vista las incidencias asignadas a los agentes de GDC. También se valora que exista un filtro donde se pueda encontrar rápidamente por nombre de categoría o de subcategoría, este mismo puede filtrar las columnas por javascript de ser necesario.

---

## Notas de implementación

### Análisis del código existente

**Modelo `Issue`** (`support/models.py`):

- `date` (DateField): Fecha de la incidencia — se usará para determinar Vencidas/Hoy/Futuras.
- `assigned_to` (FK a User): Campo para asignar incidencias a agentes.
- `category` (CharField, max_length=1): Categoría de la incidencia (L, I, M, C, W, S, O).
- `sub_category` (FK a `IssueSubcategory`): Subcategoría de la incidencia.
- `status` (FK a `IssueStatus`): Estado de la incidencia.
- `next_action_date` (DateField): Fecha de próxima acción.

**`IssueSubcategory`** (`support/models.py`):

- `name`, `slug`, `category` (CharField con choices de `get_issue_categories()`).

**`IssueFilter`** (`support/filters.py`):

- Ya soporta filtrado por: `category`, `sub_category`, `status`, `assigned_to`, `resolution`.
- Ya soporta filtrado por `date` con rangos (`date_gte`, `date_lte`) y opciones predefinidas.
- Ya soporta filtrado por `next_action_date` con rangos.
- **Conclusión**: La `IssueListView` ya puede filtrar por fecha y subcategoría via query params. Los links de la consola GDC pueden apuntar directamente a `list_issues` con los parámetros adecuados.

**Sidebar** (`templates/components/_sidebar.html`):

- Usa `{% if request.user|in_group:"NombreGrupo" %}` para mostrar/ocultar secciones.
- Usa `{% include_if_exists "sidebar_extra.html" %}` para extensiones.

### Decisiones de arquitectura

1. **Permiso**: Usaremos un permiso custom `support.can_access_community_console` en el modelo `Issue` (Meta.permissions). Nombre en inglés: "Community Management Console" / permiso: `can_access_community_console`.

2. **Acceso por sidebar**: Usaremos `request.user.has_perm('support.can_access_community_console')` en el template del sidebar en vez de `in_group`. Esto es más flexible que un grupo fijo.

3. **Vista `CommunityConsoleView`**: Nueva vista `TemplateView` con `PermissionRequiredMixin` que:
   - Consulta incidencias **no cerradas** (sin `closing_date`) asignadas al usuario actual.
   - Las agrupa por Categoría → Subcategoría.
   - Para cada agrupación, cuenta: Vencidas (`date < hoy`), Hoy (`date == hoy`), Futuras (`date > hoy`).
   - Pasa los datos al template como estructura anidada.

4. **Template `community_console.html`**: Diseño con tarjetas colapsables (accordion):
   - Cada categoría es una tarjeta con header colapsable.
   - Dentro, una tabla con columnas: Subcategoría | Vencidas | Hoy | Futuras | Total.
   - Los números son links clickeables que abren `IssueListView` con los filtros correspondientes.
   - Barra de búsqueda JS para filtrar categorías/subcategorías en tiempo real.
   - Badges con colores: rojo (vencidas), amarillo (hoy), verde (futuras).

5. **Links a `IssueListView`**: Cada celda numérica será un link con query params:
   - `?category=X&sub_category=Y&date=custom&date_gte=YYYY-MM-DD&date_lte=YYYY-MM-DD&assigned_to=Z`
   - Para "Vencidas": `date_lte=ayer`
   - Para "Hoy": `date_gte=hoy&date_lte=hoy`
   - Para "Futuras": `date_gte=mañana`

6. **URL**: `path("community_console/", CommunityConsoleView.as_view(), name="community_console")`

7. **Sidebar**: Nuevo item en `_sidebar.html` con icono `fas fa-users` y condición `has_perm`.

### Bugs encontrados y correcciones

1. **Incidencias en estado terminal**: La consola GDC no debe mostrar incidencias en estado terminal (`ISSUE_STATUS_FINISHED_LIST` en settings). Se agregó `.exclude(status__slug__in=terminal_statuses)` al queryset de `CommunityConsoleView`.

2. **Links con `None` como query param**: Cuando una incidencia no tiene subcategoría (`sub_category=None`), el template renderizaba `sub_category=None` literalmente en la URL. Esto causaba que `IssueFilter` invalidara el formulario (django-filters v23.4 con `strict=True` devuelve queryset vacío si el form es inválido), resultando en que no se mostraran resultados hasta presionar "Filtrar" manualmente. Se corrigió usando `{% if sub.id %}` para incluir condicionalmente el parámetro `sub_category`.

3. **Filtro `exclude_finished` en `IssueFilter`**: Se agregó un nuevo `BooleanFilter` con checkbox para excluir incidencias en estado terminal desde `IssueListView`. Los links de la consola GDC pasan `&exclude_finished=true` para mantener consistencia entre la consola y la vista de lista.

### Archivos a crear/modificar

- **Crear**: `support/templates/community_console.html`
- **Modificar**: `support/models.py` (agregar permission en Meta de Issue)
- **Modificar**: `support/views/all_views.py` (agregar CommunityConsoleView)
- **Modificar**: `support/urls.py` (agregar URL)
- **Modificar**: `templates/components/_sidebar.html` (agregar menú GDC)
- **Modificar**: `support/filters.py` (agregar filtro `exclude_finished`)
- **Modificar**: `support/templates/list_issues.html` (agregar checkbox `exclude_finished`)
- **Crear**: migración para el nuevo permiso
