{% extends "adminlte/base.html" %}
{% load i18n %}
{% load static %}
{% block title %}
  {% trans "Check for Existing Contacts" %}
{% endblock title %}

{% block no_heading %}
  <h1>{% trans "Check for Existing Contacts" %}</h1>
{% endblock %}

{% block content %}
  <div class="card">
    <div class="card-body">
      {% if form.errors %}
        <h4>{% trans "Form has encountered some errors" %}:</h4>
        <ul>
          {% for error in form.errors %}
            <li>{% trans "Error" %}: {{ error }}</li>
          {% endfor %}
        </ul>
      {% endif %}
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
          <label for="file">
            {% trans "Choose a CSV file to check for existing contacts. The file should have at least the following columns" %}:
          </label>
          <pre>email, phone, mobile</pre>
          <p>{% trans "All columns must be present in the header." %}</p>
          {{ form.file }}
        </div>
        <button type="submit" class="btn btn-primary">{% trans "Upload and Check" %}</button>
      </form>
    </div>
  </div>

  {% if results %}
    <div class="card mt-4">
      <div class="card-header">
        <h3 class="card-title">{% trans "Matching Contacts Found" %} ({{ results|length }})</h3>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>{% trans "Contact ID" %}</th>
                <th>{% trans "CSV Row" %}</th>
                <th>{% trans "Contact" %}</th>
                <th>{% trans "Matching Fields" %}</th>
                <th>{% trans "Has Active Subscription" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for result in results %}
                <tr>
                  <td>{{ result.contact.id }}</td>
                  <td>{{ result.csv_row }}</td>
                  <td>
                    <a href="{% url 'contact_detail' result.contact.id %}">{{ result.contact }}</a>
                  </td>
                  <td>
                    <ul class="list-unstyled mb-0">
                      {% if result.email_matches %}
                        <li class="d-inline-block mr-2">
                          <span class="badge bg-success">{% trans "Email" %} ({{ result.csv_email }})</span>
                        </li>
                      {% endif %}
                      {% if result.phone_matches %}
                        <li class="d-inline-block mr-2">
                          <span class="badge bg-info">{% trans "Phone" %} ({{ result.csv_phone }})</span>
                        </li>
                      {% endif %}
                      {% if result.mobile_matches %}
                        <li class="d-inline-block">
                          <span class="badge bg-warning">{% trans "Mobile" %} ({{ result.csv_mobile }})</span>
                        </li>
                      {% endif %}
                    </ul>
                  </td>
                  <td>
                    {% if result.has_active_subscription %}
                      <span class="badge bg-success">{% trans "Active" %}</span>
                    {% else %}
                      <span class="badge bg-danger">{% trans "Inactive" %}</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}

  {% if non_matches %}
    <div class="card mt-4">
      <div class="card-header">
        <h3 class="card-title">{% trans "No Matches Found" %} ({{ non_matches|length }})</h3>
      </div>
      <div class="card-body">
        <p>{% trans "The following entries had no matching contacts:" %}</p>
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>{% trans "Email" %}</th>
                <th>{% trans "Phone" %}</th>
                <th>{% trans "Mobile" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for row in non_matches %}
                <tr>
                  <td>{{ row.email|default:"-" }}</td>
                  <td>{{ row.phone|default:"-" }}</td>
                  <td>{{ row.mobile|default:"-" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}
